# 共通基盤システム仕様書

## 概要

本システムは「木」のメタファーに基づくタスク管理兼プロジェクト管理基盤である。成果物の管理からタスク実行、知識蓄積、素材管理までを一元化し、ゲーミフィケーション要素によって継続的なモチベーションを支える。

### 設計原則

1. **Portal起点のアクセス** — すべての情報はPortal（テーマ別ダッシュボード）を起点にアクセスする。ユーザーは自分の活動領域ごとのPortalを開き、そこから成果物・タスク・イシュー・ナレッジを操作する。
2. **タグ経由の間接参照** — Portal と各DBは直接リレーションを持たない。DB_Tag がPortalと各DBの間を取り持ち、タグのrollup値でフィルタリングすることにより、各Portalに関連するデータだけが表示される。これがシステム全体のフィルタリングの根幹である。
3. **ゲーミフィケーション** — タスク完了で経験値が蓄積し、成果物がレベルアップして称号が変化する。見積より早く完了するとボーナスが発生する。

---

## システム構成図

```
Portal（ポータル）
  │
  └──双方向──→ DB_Tag（タグ）
                  │
        ┌────────┼────────┬──────────┐
        ▼        ▼        ▼          ▼
    DB_Nuts   DB_Trunk   DB_Root   DB_Resource
    (成果物)  (イシュー) (ナレッジ) (リソース)
        │  │       │
        │  │   DB_Leaf（タスク）
        │  │       │
        │  │   DB_Difficulty（難易度マスタ）
        │  │
        │  └── DB_Worklog（作業記録）
```

### フィルタリングの仕組み

Portal自身は他のDBを直接参照しない。データの帰属は以下の経路で決まる。

```
Portal ←双方向→ DB_Tag ←リレーション← DB_Nuts / DB_Trunk / DB_Root / DB_Resource
                                           │
                                    rollup で「ポータル名」を取得
                                           │
                              各Portalのリンクドビューでポータル名フィルタ
```

つまり、あるデータがどのPortalに属するかは「そのデータに付けられたタグがどのPortalに属しているか」で自動的に決まる。

---

## Portal（ポータル）

### 役割

ワークスペース全体の最上位ハブ。生活・仕事・趣味・創作など、人生のあらゆる領域を1つのポータルページとして独立させる。各ポータルページ内に共通基盤DB群のリンクドビューと固有DBを配置する。

### プロパティ

| プロパティ | 型 | 説明 |
|---|---|---|
| ページ | title | ポータル名 |
| カテゴリ | select | `🎨 創作・開発` / `📝 思考・学習` / `📋 仕事・キャリア` / `🏠 生活・健康` / `🎮 エンタメ・趣味` |
| オススメ度 | select | ★1〜★10（重要度・使用頻度） |
| Comment | text | 補足説明 |
| オーナー | person | 管理者 |
| タグ | relation → DB_Tag | このポータルに属するタグ一覧（双方向） |
| 最終更新日時 | last_edited_time | 自動記録 |
| 有効期限 | verification | Wiki機能の検証プロパティ |

### ビュー

| ビュー | 型 | 用途 | フィルタ | ソート |
|---|---|---|---|---|
| リスト | List | メイン閲覧用 | カテゴリが空でない | オススメ度 降順 |
| ギャラリー | Gallery（カードS） | ビジュアル閲覧用 | カテゴリが空でない | — |
| テーブル | Table | 管理用（全プロパティ表示） | カテゴリが空でない | — |

カテゴリ未設定のポータルは全ビューで非表示。下書き・非公開として扱われる。

### ポータルページの構成パターン

ポータルページ内部は3パターンに分かれる。

**パターンA：フル構成**（大半のポータル）
```
[装飾引用 + ボタン]
DB_Nuts リンクドビュー（Gallery）
┌──────────┬───────────┐
│ DB_Leaf   │ DB_Trunk  │  ← 2カラム
│（Gallery） │（Gallery） │
└──────────┴───────────┘
DB_Root リンクドビュー（Table）
```

**パターンB：簡易タスク**（固有DBがメインのポータル）
```
[固有DB群]
┌──────────┬───────────┐
│ DB_Leaf   │ Inbox     │
└──────────┴───────────┘
```
Nuts / Trunk / Root のリンクドビューを持たない軽量構成。

**パターンC：ハイブリッド**（重厚な創作系ポータル）
```
[固有DBセクション]
---
パターンAのフル構成
---
DB_Resource リンクドビュー
```

### 実装上の要件

- 新規ポータル作成時、パターンAの構成（Nuts・Leaf・Trunk・Rootの4つのリンクドビュー）が自動配置されること
- 各リンクドビューは、そのポータル名でフィルタリングされた状態で表示すること
- パターンB・Cはユーザーが手動でカスタマイズする前提。自動生成はパターンAのみでよい

---

## DB_Nuts（成果物管理）

### 役割

プロジェクト・成果物単位の最上位管理DB。1つの成果物に対して複数のイシュー（Trunk）やタスク（Leaf）がぶら下がる。ゲーミフィケーションが組み込まれており、タスクをこなすほど成果物がレベルアップし、称号が変化する。

### プロパティ

| プロパティ | 型 | 説明 | 必須 |
|---|---|---|---|
| 名前 | title | 成果物の名称 | ○ |
| ステータス | status | 下記ステータス表を参照 | ○ |
| 優先度 | select | 高 / 中 / 低 | ○ |
| 難易度 | select | ★1〜★10（10段階） | — |
| バージョン | select | 未完 / v1.0 / v2.0 | — |
| 作業開始日時 | date | 作業開始のタイムスタンプ | — |
| 本締切日時 | date | 最終締切 | — |
| タグ | relation → DB_Tag | 分類タグ | ○ |
| タスク | relation → DB_Leaf | 紐づく全タスク | — |
| 作業記録 | relation → DB_Worklog | 作業ログ | — |
| 紹介文 | text | 成果物の説明 | — |
| 公開URL | url | 公開先リンク | — |
| 作成日時 | created_time | 自動記録 | 自動 |

「タグ」は必須。タグがないとPortalへの帰属が決まらず、どのポータルにも表示されなくなる。

### ステータス遷移

```
To Do
  ├── いつかやる（初期状態）
  ├── 中断
  └── 没

In Progress
  └── 構想中 → モック → 本作業中 → 動作確認
      → 1回目テスト → 1回目修正 → 最終テスト → 最終修正 → レビュー待ち

Complete
  └── 完了
```

ステータスは手動で遷移させる。In Progress内の細かい段階はゲーム開発のようにフェーズが明確なプロジェクトで使う。軽いタスクでは「構想中→本作業中→完了」のように飛ばしてよい。

### 数式プロパティ

#### マイルストーン（締切の自動分割）

作業開始日時〜本締切日時の期間を5段階に自動分割する。

```
|← 緑フェーズ(50%) →|← 黄(15%) →|← 赤(15%) →|← 最終ライン(15%) →|← 炎上(5%) →|
作業開始            緑MS         黄MS         赤MS         デッドライン      本締切
```

| 数式名 | 算出位置 |
|---|---|
| 緑MS | 作業開始から全体の50%地点 |
| 黄MS | 作業開始から全体の65%地点 |
| 赤MS | 作業開始から全体の80%地点 |
| デッドライン | 作業開始から全体の95%地点 |

#### フェーズ（現在位置の判定）

| 数式名 | ロジック |
|---|---|
| フェーズ | 現在日時がどのマイルストーン区間にいるかを判定。`🕒 開始前` → `🟢 緑フェーズ` → `🟡 黄フェーズ` → `⚠️ 締切間近` → `🚨 最終ライン` → `🔥 炎上` → `✅ 完了` |
| フェーズ（並替用） | フェーズを数値に変換（ソート用） |
| 直近締切 | 次に到来するマイルストーンの日時 |

#### 進捗率

ステータスに応じた固定パーセンテージを返す。

| ステータス | 進捗率 |
|---|---|
| 構想中 | 10% |
| モック | 25% |
| 本作業中 | 50% |
| 動作確認 | 60% |
| 1回目テスト | 70% |
| 1回目修正 | 80% |
| 最終テスト | 85% |
| 最終修正 | 90% |
| レビュー待ち | 95% |
| 完了 | 100% |

#### ゲーミフィケーション

| 数式名 | ロジック |
|---|---|
| 経験値合計 | 経験値小計（rollup） + 完了ボーナス（rollup） × 2 |
| レベル | 経験値合計から3段階の成長曲線で算出（Lv1〜100）。序盤は上がりやすく、終盤は上がりにくい |
| 次の経験値まで | レベル² × 10 − 現在の経験値小計 |
| 実績アイテム | レベル帯ごとに称号を表示（例：Lv1〜3＝《銀樹の羽根ペン》、Lv100＝《神核変異体アダム=カドモン》） |

#### アイゼンハワーマトリクス

| 数式名 | ロジック |
|---|---|
| アイゼンハワー | 優先度×フェーズの2軸で4象限に自動分類。`🔥 今すぐやる`（高優先＆切迫）/ `🌿 余裕をもってやる`（高優先＆余裕）/ `⚡ 任せる`（低優先＆切迫）/ `🗑 やらなくてよい`（低優先＆余裕） |

### ロールアップ

| プロパティ | 取得元 | 説明 |
|---|---|---|
| ポータル | Tag → Portal名 | この成果物が属するポータル |
| 経験値小計 | Leaf → 経験値小計の合計 | 全タスクの経験値合算 |
| 完了ボーナス | Leaf → ボーナスの合計 | 全タスクのボーナス合算 |

### ビュー

| ビュー | 型 | フィルタ | ソート |
|---|---|---|---|
| キープ | Gallery（カードS） | ステータスが In Progress または いつかやる | 優先度 昇順 |
| アーカイブ | Gallery（カードS） | ステータスが Complete / 中断 / 没 | 優先度 昇順 |

### ボタン

| ボタン | 動作 |
|---|---|
| 作業開始 | 作業開始日時をセット、ステータスを進行中に変更、DB_Worklogにスナップショットを生成 |
| 完了！ | ステータスを完了に変更 |
| タスク追加 | DB_Leafに新規ページ作成（親Nutsを自動リンク） |
| イシュー追加 | DB_Trunkに新規ページ作成（親Nutsを自動リンク） |
| ナレッジ追加 | DB_Rootに新規ページ作成 |

---

## DB_Trunk（イシュー管理）

### 役割

Nutsの下にぶら下がる課題・論点・アイデアの中間管理層。**「なぜやるか」「何が問題か」を記述する層であり、具体的な作業指示は書かない。** 「イシュー」と「非イシュー」を区別して、解決すべき問題と単なるメモを分離する。

### プロパティ

| プロパティ | 型 | 説明 | 必須 |
|---|---|---|---|
| タイトル | title | イシューの名称 | ○ |
| ステータス | status | 未着手 / 進行中 / 完了 | ○ |
| タイプ | select | 非イシュー（単なる情報） / イシュー（解決すべき課題） | ○ |
| バリュー | select | ★★★（高）/ ★★☆（中）/ ★☆☆（低） | — |
| 成果物 | relation → DB_Nuts | 親の成果物（1件制限） | ○ |
| DB_Leaf | relation → DB_Leaf | このイシューから生まれたタスク | — |
| DB_Tag | relation → DB_Tag | 分類タグ | — |
| What | text | 何が起きているか・何を明らかにしたいか | — |
| アイデア | text | 解決案・仮説の候補 | — |
| イシュー | text | 課題の詳細記述 | — |
| 詳細 | text | 追加情報 | — |
| コメント | text | 自由メモ | — |

### ロールアップ・数式

| プロパティ | 説明 |
|---|---|
| ハブ | 成果物→タグ→ポータル経由でポータル名を取得 |
| ハブ（フィルタリング用） | ハブの値をそのまま返す数式。各Portalのリンクドビューでフィルタに使用 |

### ビュー（Portalリンクドビュー）

| ビュー | 型 | フィルタ | ソート |
|---|---|---|---|
| インデックス | Gallery（カードM） | バリュー★★以上、ステータスが未着手/進行中、ハブが該当ポータル名 | 作成日時 降順 |

### ボタン

| ボタン | 動作 |
|---|---|
| タスク追加 | DB_Leafに新規ページ作成（親イシューを自動リンク） |

---

## DB_Leaf（タスク管理）

### 役割

実際に手を動かす最小実行単位のタスク。チケット制で管理される。**「何をやるか」だけを記述し、背景や理由はDB_Trunkを参照する。** タスクの開始〜終了の時間から経験値を算出し、親のNutsに蓄積される。

### プロパティ

| プロパティ | 型 | 説明 | 必須 |
|---|---|---|---|
| タイトル | title | タスク名 | ○ |
| 優先度 | select | 高 / 中 / 低 | ○ |
| 成果物 | relation → DB_Nuts | 親の成果物 | ○ |
| イシュー | relation → DB_Trunk | 親のイシュー（1件制限） | — |
| 難易度 | relation → DB_Difficulty | 難易度マスタへの参照（1件制限） | ○ |
| 開始日時 | date | タスク着手日時 | — |
| 終了日時 | date | タスク完了日時 | — |
| 備考 | text | 補足メモ | — |
| 作成日時 | created_time | 自動記録 | 自動 |
| 最終更新日時 | last_edited_time | 自動記録 | 自動 |

「成果物」は必須。成果物が未設定だとポータルへの帰属が決まらない。

### ロールアップ

| プロパティ | 取得元 | 説明 |
|---|---|---|
| タグ | 成果物 → タグ | 成果物のタグを取得 |
| ポータル | 成果物 → タグ → ポータル名 | 所属ポータルを取得 |
| 注意書き | 難易度マスタ → 注意書き | RPG風フレーバーテキスト |
| 経験値 | 難易度マスタ → 見積時間 | 基礎経験値（見積時間） |

### 数式プロパティ

| 数式名 | ロジック |
|---|---|
| ステータス | 開始・終了日時の有無で自動判定。未着手（両方空）/ 進行中（開始あり・終了なし）/ 完了（両方あり） |
| 実績 | 終了日時 − 開始日時（時間単位） |
| ボーナス | 経験値（見積）− 実績。見積より早く完了した分がボーナス |
| 経験値小計 | 実績 + ボーナス |
| ポータル（フィルタリング用） | ポータル名をそのまま返す。リンクドビューのフィルタに使用 |

### 経験値フロー

```
1. タスクに難易度マスタ（Easy/Normal/Hard）を設定
   → Easy=0.5h, Normal=2h, Hard=5h が見積経験値

2. 「スタート」ボタン → 開始日時に現在時刻がセット

3. 「完了！」ボタン → 終了日時に現在時刻がセット

4. 実績 = (終了日時 − 開始日時) を時間換算

5. ボーナス = 見積経験値 − 実績（正の場合のみ）

6. 経験値小計 = 実績 + ボーナス

7. 親NutsのrollupでLeaf全体の経験値小計・ボーナスを合算

8. Nutsの経験値合計 → レベル → 称号が自動更新
```

### ビュー（Portalリンクドビュー）

| ビュー | 型 | フィルタ | ソート |
|---|---|---|---|
| 未完了 | Gallery（カードM） | 終了日時が空、ポータルが該当名 | 開始日時 降順 |

### ボタン

| ボタン | 動作 |
|---|---|
| スタート | 開始日時に現在時刻をセット |
| 完了！ | 終了日時に現在時刻をセット |

### テンプレート

新規作成時の初期値は、優先度＝中、難易度＝Easy（見積0.5h）。

---

## DB_Difficulty（難易度マスタ）

### 役割

タスクの難易度と見積時間を定義するマスタDB。DB_Leafからリレーションで参照される。

### 登録データ

| 名前 | 見積時間 | 意味 |
|---|---|---|
| Easy | 0.5h | 軽い作業。30分以内の想定 |
| Normal | 2h | 標準的な作業。2時間の想定 |
| Hard | 5h | 重い作業。5時間の想定 |

見積時間がそのまま基礎経験値として使われる。

---

## DB_Worklog（作業記録）

### 役割

Nutsの「作業開始」ボタンが押されるたびにスナップショットとして記録が生成されるログDB。作業のたびに成果物の状態を保存する。

### プロパティ

| プロパティ | 型 | 説明 |
|---|---|---|
| 名前 | title | 自動生成（「○○の作業記録：YY-MM-DD HH:MM」） |
| 成果物 | relation → DB_Nuts | 対象の成果物（1件制限） |
| 作業開始日時 | created_time | レコード作成日時＝作業開始 |
| 完了日時 | date | 作業完了の日時 |
| 完了時ステータス | text | 完了時点のNutsのステータス |
| 完了時フェーズ | text | 完了時点のフェーズ |
| 完了時レベル | text | 完了時点のレベル |
| 完了時締切日時 | date | 完了時点の締切 |
| 備考 | text | メモ |

---

## DB_Root（ナレッジ管理）

### 役割

タスクとは独立した知識資産を蓄積するDB。学びやノウハウを分類して保管する。

### プロパティ

| プロパティ | 型 | 説明 | 必須 |
|---|---|---|---|
| タイトル | title | ナレッジの名称 | ○ |
| タイプ | select | ナレッジ / シード / ガイド / コラム / アーカイブ | ○ |
| バリュー | select | ★1〜★10（重要度） | — |
| 難易度 | select | ★ / ★★ / ★★★（理解難易度） | — |
| 成果物 | relation → DB_Nuts | 関連する成果物（1件制限） | — |
| タグ | relation → DB_Tag | 分類タグ | — |
| What | text | 何についての知見か | — |
| 詳細 | text | 具体的な内容 | — |
| コメント | text | 補足・振り返り | — |
| URL | url | 参考リンク | — |

### タイプの意味

| タイプ | 意味 |
|---|---|
| ナレッジ | 確立された知識・ノウハウ |
| シード | まだ芽の段階のメモ・断片 |
| ガイド | 手順書・チュートリアル |
| コラム | 考察・意見 |
| アーカイブ | 役目を終えた情報の保管 |

### ロールアップ

| プロパティ | 説明 |
|---|---|
| ポータル | タグ→ポータル名を取得 |

### ビュー（Portalリンクドビュー）

| ビュー | 型 | フィルタ | ソート |
|---|---|---|---|
| ナレッジ | Table | タイプがナレッジ/シード/コラム/ガイド（アーカイブ除外） | 作成日時 降順 |

---

## DB_Tag（タグ管理）

### 役割

全DBを横断的に繋ぐ分類ハブ。Portal ↔ Tag ↔ 各DBの間を取り持つ、システム全体の要。

### プロパティ

| プロパティ | 型 | 説明 |
|---|---|---|
| タグ名 | title | タグの名称 |
| ポータル | relation → Portal | このタグが属するポータル（双方向） |
| 成果物 | relation → DB_Nuts | 成果物との双方向リレーション |
| お気に入り | checkbox | よく使うタグのフラグ |
| 備考 | text | 補足説明 |
| ポータル：カテゴリ | rollup | ポータルのカテゴリを自動取得 |

### 運用ルール

- タグは客観的な名詞のみ（「Unity」「音楽制作」「データベース」など）
- 形容詞や動詞はタグにしない（「重要」「急ぎ」は優先度プロパティで扱う）
- 1つのタグが複数のPortalに属してもよい

### 接続先

DB_Tagは以下の4つのDBからリレーションで参照される。

1. DB_Nuts → 「タグ」リレーション
2. DB_Trunk → 「DB_Tag」リレーション
3. DB_Root → 「タグ」リレーション
4. DB_Resource → 「DB_Tag」リレーション

---

## DB_Resource（リソース管理）

### 役割

画像・文書・音楽・動画・歌詞といった素材・アセットを管理するDB。

### プロパティ

| プロパティ | 型 | 説明 |
|---|---|---|
| 名前 | title | リソース名 |
| 種類 | select | 画像 / 文書 / 音楽 / 動画 / 歌詞 |
| DB_Tag | relation → DB_Tag | 分類タグ |
| Portal | rollup | タグ経由でポータル名を取得 |
| 作成日時 | created_time | 自動記録 |

---

## リレーション一覧（実装要件）

以下は全DBの外部キー的な接続関係である。「必須」は、そのリレーションが未設定だとシステムのフィルタリングやデータ集計が壊れることを意味する。

| 元DB | プロパティ | 先DB | 件数制限 | 必須 | 理由 |
|---|---|---|---|---|---|
| Portal | タグ | DB_Tag | 多対多 | — | 双方向。タグの帰属定義 |
| DB_Tag | ポータル | Portal | 多対多 | ○ | 未設定だとフィルタリング不能 |
| DB_Tag | 成果物 | DB_Nuts | 多対多 | — | 双方向フィルター用 |
| DB_Nuts | タグ | DB_Tag | 多対多 | ○ | 未設定だとPortalに表示されない |
| DB_Nuts | タスク | DB_Leaf | 1対多 | — | タスクの紐づけ |
| DB_Nuts | 作業記録 | DB_Worklog | 1対多 | — | ログ連携 |
| DB_Trunk | 成果物 | DB_Nuts | 1件制限 | ○ | 親成果物の特定 |
| DB_Trunk | DB_Leaf | DB_Leaf | 1対多 | — | タスクの紐づけ |
| DB_Trunk | DB_Tag | DB_Tag | 多対多 | — | 分類 |
| DB_Leaf | 成果物 | DB_Nuts | 多対1 | ○ | 未設定だとPortalに表示されない |
| DB_Leaf | イシュー | DB_Trunk | 1件制限 | — | 親イシューの特定 |
| DB_Leaf | 難易度 | DB_Difficulty | 1件制限 | ○ | 経験値計算に必要 |
| DB_Root | 成果物 | DB_Nuts | 1件制限 | — | 関連成果物 |
| DB_Root | タグ | DB_Tag | 多対多 | — | 分類 |
| DB_Resource | DB_Tag | DB_Tag | 多対多 | — | 分類 |
| DB_Worklog | 成果物 | DB_Nuts | 1件制限 | ○ | 対象成果物の特定 |

---

## 操作フロー

### 新しい成果物を始める

1. DB_Nutsに新規ページを作成（名前・紹介文を入力）
2. DB_Tagから適切なタグを設定（→ これでPortalへの帰属が決まる）
3. 優先度・難易度を設定
4. ステータスは「いつかやる」（すぐ着手するなら「作業開始」ボタン）
5. 必要に応じてDB_Trunkにイシューを作成
6. イシューまたはNutsからDB_Leafにタスクを分解

### 日常の作業

1. Portalページを開く
2. 未完了タスク（DB_Leafリンクドビュー）から作業対象を選ぶ
3. 「スタート」ボタンを押す → 開始日時がセットされる
4. 作業する
5. 「完了！」ボタンを押す → 終了日時がセットされ、経験値が計算される
6. 親Nutsのレベル・称号が自動更新される

### 振り返り

1. DB_Worklogで作業履歴を確認
2. DB_Rootのシードを見直し、育てるものはナレッジに昇格
3. DB_Trunkの未完了イシューを確認し、優先度を見直す
4. Nutsのアイゼンハワーマトリクスで次に何をやるか判断する